# Review by Claudesdk

**Model**: claude-haiku-4-5-20251001
**Timestamp**: 2025-11-04T15:47:10.224085

## Feedback

1-b 단계 Outside-In TDD 구현 리허설 문서를 검토하겠습니다.문서를 꼼꼼히 검토했습니다. 다음과 같이 평가합니다:

---

## 정확성

**대부분 문제 없음. 단, 다음 사항들을 지적합니다:**

### 1. 기술적 오류

**SQLite Row Factory 관련 오류 (2.3 Step 6)**
```python
conn.row_factory = sqlite3.Row
```
- 이 설정은 `sqlite3.Row` 객체를 반환하며, `dict(row)`로 변환 가능하지만 순수한 dict는 아닙니다
- 문서에서는 "dict 형태로 반환"이라고 했으나, 정확하게는 "Row 객체를 dict로 변환 가능하게 함"입니다
- 실제 코드에서는 `dict(row)` 변환이 필요합니다

**HTTPException detail 형식 오류 (2.3 Step 4)**
```python
raise HTTPException(
    status_code=404,
    detail={
        "error": "주문을 찾을 수 없습니다",
        "code": "ORDER_NOT_FOUND"
    }
)
```
- FastAPI의 `HTTPException`의 `detail` 파라미터는 기본적으로 문자열을 기대합니다
- dict를 전달하면 JSON으로 자동 변환되지만, 응답 형식은 `{"detail": {...}}` 형태가 됩니다
- 문서의 "실패 응답" 예시와 실제 응답 형식이 다를 수 있습니다
- 정확한 응답을 위해서는 커스텀 예외 핸들러가 필요합니다

### 2. 논리적 불일치

**Service Layer의 필요성 (섹션 3.6에서 질문했으나 답 없음)**
- 현재 OrderService는 단순 위임만 하고 있습니다
- 문서에서도 "현재는 단순 위임"이라고 인정했으나, 이것이 YAGNI 원칙과 모순됩니다
- Outside-In TDD라면 실제 필요할 때 Service Layer가 도출되어야 하는데, 처음부터 비어있는 레이어를 만든 것은 방법론과 맞지 않습니다

**execute_update 헬퍼 함수 (1.5, 2.3 Step 6)**
- 1-b 단계에서는 UPDATE 쿼리를 사용하지 않는다고 명시했습니다
- 그런데도 `execute_update` 헬퍼를 소개하는 것은 YAGNI 원칙 위반입니다
- Outside-In TDD 흐름에서 벗어난 선제적 구현입니다

### 3. 사실 오류

**가격 단위 설명 (1.5)**
```sql
price INTEGER NOT NULL,  -- 센타보(centavo) 단위
```
- 필리핀 페소의 센타보는 1/100 페소 단위입니다
- 그런데 샘플 데이터에서 `price: 57500`을 사용하고 있습니다
- 만약 센타보 단위라면 575.00 페소인데, UI에서는 `₱575.00`으로 표시되어야 합니다
- 하지만 실제 의도는 "57,500원"으로 보이며, 단위 설명이 잘못되었거나 가격 값이 잘못되었습니다

---

## 적절성

**몇 가지 개선이 필요한 부분이 있습니다:**

### 1. 맥락 적합성 문제

**Outside-In TDD 방법론 적용의 불일치**
- 문서는 "Outside-In TDD"를 표방하지만, 실제로는 전통적인 계층형 아키텍처를 먼저 설계하고 테스트를 작성했습니다
- 진정한 Outside-In이라면:
  - E2E 테스트가 실패 → 필요한 인터페이스만 최소한으로 도출
  - Service Layer가 필요하다는 것을 **테스트가 증명**해야 함
  - 현재는 "3-Layer 아키텍처"를 전제하고 시작했습니다
- 이는 학습 목적으로는 괜찮지만, "Outside-In TDD 실습"이라는 목표와는 맞지 않습니다

**MVP 범위에 비해 과도한 인프라 (섹션 3)**
- 1-b 단계는 단순 조회 기능 1개입니다
- 그런데 문서는:
  - Factory 패턴 (3.3.3)
  - UI E2E 테스트 (3.6)
  - Connection Pool 논의 (검토 요청 5)
  - 트랜잭션 롤백 전략 (3.5.2)
- 이는 MVP 단계에서는 과도하며, 조기 최적화의 위험이 있습니다

### 2. 완전성 문제

**Step 4에서 Step 5로의 비약**
- Step 4: Mock Repository로 모든 테스트 통과
- Step 5: 갑자기 Service Unit 테스트 작성
- **누락**: Step 4에서 통과한 테스트들이 Mock을 사용하고 있다는 명확한 표시
- **누락**: "이제 Mock을 실제 구현으로 교체하기 위해 아래로 내려간다"는 명시적 전환점

**주문번호 생성 로직 누락**
- 문서는 "주문 생성 기능 없음 (Mock 데이터 사용)"이라고 했으나, 실제 1-a 단계에서는 주문번호 생성이 필요합니다
- `ORD-12345678` 형식의 생성 규칙이 명시되지 않았습니다
- 검토 요청 4에서 "주문번호 형식 검증"을 언급했으나, 정작 형식 규칙 자체가 정의되지 않았습니다

**404 응답 형식 불일치**
- API 명세 (1.4): `{"error": "...", "code": "..."}`
- 실제 구현 (Step 4): `HTTPException(detail={...})`
- FastAPI 기본 동작: `{"detail": {...}}`
- 이 불일치가 해결되지 않았습니다

### 3. 명확성 문제

**용어 혼용**
- "통합 테스트"라는 용어가 두 가지 의미로 사용됩니다:
  1. API + Service + Repository 테스트 (3.1.1 표)
  2. Repository + DB 테스트 (3.1.1 표)
- 혼란을 방지하려면 "API Integration Test", "Repository Integration Test"로 명확히 구분해야 합니다

**Fixture 의존성 그래프 부재**
- 섹션 3.2.3에서 `sample_order_in_db`는 `db_connection`과 `sample_order_data`에 의존합니다
- 그런데 `db_connection`이 `setup_test_db`에 의존한다는 것이 명시되지 않았습니다
- Fixture 체인이 복잡해질수록 의존성 그래프가 필요합니다

**"리허설"의 의미 모호**
- 제목은 "구현 리허설"인데, Step 10까지 보면 실제 구현입니다
- "리허설"이 "계획"인지 "이미 구현한 것의 회고"인지 불명확합니다
- "검토 요청"을 보면 구현 전인 것처럼 보이지만, Step들은 과거형으로 작성되었습니다

### 4. 누락된 중요 정보

**에러 처리 전략**
- 404 외의 에러는 어떻게 처리하나요?
  - DB 연결 실패
  - SQL 문법 오류
  - 잘못된 order_number 형식 (특수문자 등)
- Outside-In TDD라면 이런 예외 상황도 테스트로 먼저 정의되어야 합니다

**테스트 데이터 정리 (Teardown)**
- `setup_test_db`에서 `TEST_DB_PATH.unlink(missing_ok=True)`를 사용합니다
- 그런데 테스트가 실패하면 yield 이후 코드가 실행되지 않을 수 있습니다
- `try-finally` 또는 `@contextmanager` 사용이 더 안전합니다

**동시성 고려**
- SQLite는 기본적으로 동시 쓰기를 지원하지 않습니다
- 1-b는 조회만이지만, 1-a에서 주문 생성 시 경합 조건(race condition)이 발생할 수 있습니다
- 이에 대한 언급이 없습니다

### 5. 실용성 문제

**UI 테스트의 ROI 분석 (3.6.3)**
- "UI E2E는 ROI가 낮다"고 결론 내렸으면서도 3.6.1-3.6.2에서 자세히 설명합니다
- MVP에서는 불필요하다고 판단했다면, 섹션 3.6 전체를 "향후 고려사항"으로 옮기는 것이 적절합니다
- 현재 위치는 "지금 해야 할 것"처럼 보입니다

**검토 요청 사항의 모호함**
- ⚠️ 표시가 7개 중 6개입니다
- 모든 것이 불확실하다면, "리허설"이 아니라 "초안"입니다
- 정작 검토가 필요한 핵심 질문은:
  - "이 접근 방식으로 1-a 단계를 진행해도 되는가?"
  - "아키텍처를 지금 변경해야 하는가, 나중에 리팩토링해도 되는가?"

---

## 종합 의견

이 문서는 **학습용 자료로는 우수하지만, 실제 구현 가이드로는 몇 가지 수정이 필요합니다**.

**강점:**
- TDD 흐름을 단계별로 잘 설명했습니다
- 테스트 조직화 전략이 체계적입니다
- 실무적 고민(성능, 격리, ROI)을 포함했습니다

**약점:**
- Outside-In TDD 방법론과 실제 구현이 불일치합니다 (계층을 먼저 설계함)
- MVP 범위를 벗어난 과도한 인프라 논의가 있습니다
- 몇 가지 기술적 오류(HTTPException detail, 가격 단위)가 있습니다
- "리허설"인지 "회고"인지 "계획"인지 불명확합니다

**권장 사항:**
1. HTTPException detail 처리를 수정하거나 커스텀 핸들러 추가
2. Service Layer를 당장 제거하거나, 왜 필요한지 명확한 근거 제시
3. "Outside-In TDD"라는 용어를 "Layered TDD" 또는 "Top-Down TDD"로 변경
4. 섹션 3.6(UI 테스트)을 부록으로 이동
5. 검토 요청 사항을 핵심 질문 2-3개로 압축
