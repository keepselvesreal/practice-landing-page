# Review by Claudesdk

**Model**: claude-haiku-4-5-20251001
**Timestamp**: 2025-11-03T20:00:50.320526

## Feedback

# 비판적 검토 결과

## 정확성

### 1. 사실 오류
- **가격 표기 오류**: "575원"은 현실적인 화장품 가격이 아닙니다. 조선미녀 맑은쌀 선크림 50ml의 실제 시장가는 10,000원대입니다. 테스트 목적이라면 명시가 필요합니다.

### 2. 논리 오류

#### 2.1 재고 관리 시점의 모순
- **문제**: "주문 생성 시(결제 전) 재고 차감" + "환불 완료 시 재고 복구"의 조합에 논리적 결함 존재
- **시나리오**: 
  1. 사용자 A가 주문 생성 → 재고 차감 (결제 전)
  2. 사용자 A가 결제 포기/실패 → 재고는 어떻게 되는가?
- **문제점**: 결제 실패/포기 시 재고 복구 로직이 명세되지 않음. 이는 "유령 재고 차감" 문제를 야기합니다.

#### 2.2 주문 상태 플로우의 불완전성
- **PAYMENT_PENDING 상태의 처리 미흡**: 이 상태에서 사용자가 이탈하거나 결제 실패 시의 처리가 정의되지 않음
- **CANCELLED vs REFUNDED 구분의 모호함**: 
  - CANCELLED: "결제 완료 후 취소, 재고 복구" (PayPal 환불 처리 언급 없음)
  - REFUNDED: "PayPal API로 환불 처리, 재고 복구"
  - 둘 다 결제 완료 후 발생하는데 차이가 불명확함

### 3. 기술적 오류

#### 3.1 동시성 제어 불충분
- **트랜잭션 처리만으로 동시성 제어 충분하다는 주장의 오류**:
  - SQLite3는 데이터베이스 레벨 락을 사용하지만, 애플리케이션 레벨에서 SELECT → UPDATE 패턴 사용 시 race condition 발생 가능
  - "재고 10개, A와 B가 동시에 10개 주문" 시나리오에서 트랜잭션만으로는 불충분
  - `SELECT * FROM products WHERE stock >= quantity FOR UPDATE` 같은 명시적 락 전략이 필요하지만 명세되지 않음

#### 3.2 PayPal 통합 검증 누락
- **문서에서 "서버 사이드에서 결제 검증"이라고만 명시**: 구체적 검증 방법 부재
- **필수 검증 항목 누락**:
  - Webhook 서명 검증
  - 금액 일치 여부 검증 (클라이언트가 조작한 금액과 서버 계산 금액 비교)
  - 주문 상태 중복 처리 방지 (같은 paypal_order_id로 여러 번 완료 시도)

#### 3.3 데이터베이스 스키마 오류
- **orders.updated_at 자동 업데이트 미지정**: `DEFAULT CURRENT_TIMESTAMP`만 있고, `ON UPDATE CURRENT_TIMESTAMP` 없음 (SQLite는 이를 지원하지 않으므로 애플리케이션 레벨 처리 필요하나 명시 안 됨)
- **shipments.order_id UNIQUE 제약의 문제**: 환불 후 재주문 시나리오에서 문제 가능성 (동일 order_id에 새 shipment 생성 불가)

---

## 적절성

### 1. 맥락 적합성

#### 1.1 MVP 목적 대비 과도한 설계
- **환불 프로세스가 과도하게 복잡**: "관리자 수동 승인 + refunds 테이블 + 환불 사유 입력"은 "탐색 목적의 최소 기능"과 불일치
- **shipments 테이블 분리의 과도한 정규화**: MVP에서 orders 테이블에 통합해도 충분

#### 1.2 보안 정책의 부적절성
- **관리자 페이지 인증 없음**: "MVP 단순화"를 이유로 들었으나, 환불 승인 같은 민감한 작업을 인증 없이 노출하는 것은 부적절
- **최소한 환경변수 기반 단순 토큰 인증 정도는 필요**

### 2. 완전성

#### 2.1 명세 누락 항목

**결제 실패/포기 처리**:
- PAYMENT_PENDING 상태에서 결제 미완료 시 재고 복구 로직 없음
- 타임아웃 정책 부재 (24시간 후 자동 취소?)

**에러 케이스 처리 불충분**:
- PayPal API 호출 실패 시 처리 (환불 요청이 실패하면?)
- 네트워크 타임아웃 시 재시도 정책
- 재고 복구 실패 시 보상 트랜잭션

**데이터 무결성 보장 방안 부재**:
- `order.total_amount`와 `order.unit_price * order.quantity` 불일치 가능성 검증 로직 없음
- 환불 금액(`refund_amount`)이 주문 금액보다 큰 경우 검증 없음

**주문번호 충돌 처리**:
- `ORD-XXXXXXXX` 생성 시 UNIQUE 제약 위반 가능성 (충돌 시 재시도 로직 명시 필요)

#### 2.2 API 엔드포인트 명세 누락
- 문서에 페이지 구성만 있고, 실제 API 엔드포인트 정의 없음:
  - `POST /orders` (주문 생성)
  - `GET /orders/{order_number}` (주문 조회)
  - `POST /orders/{id}/cancel` (주문 취소)
  - `POST /refunds` (환불 요청)
  - `POST /admin/refunds/{id}/approve` (환불 승인)
  - 등의 엔드포인트 사양 필요

### 3. 명확성

#### 3.1 용어 혼란
- **"주문 취소"와 "환불"의 구분 불명확**: 
  - 둘 다 "결제 완료 후" 발생
  - 둘 다 "재고 복구" 발생
  - 차이점이 "PayPal API 호출 여부"뿐인데, 주문 취소 시에도 결제가 완료되었으면 PayPal 환불이 필요함
  - **실제 의도 추정**: 취소 = 배송 전, 환불 = 배송 후? 이를 명확히 해야 함

#### 3.2 상태 전이 다이어그램 부재
- 4개 상태 체계(order_status, payment_status, shipping_status, refund_status)가 있으나 상호작용이 불명확
- 예: `order_status=PAID`이고 `payment_status=PENDING`인 경우가 가능한가?

#### 3.3 Outside-In TDD 시작점 불명확
- "E2E 테스트부터 시작"이라고만 되어 있고, 구체적 시작 시나리오 없음
- 첫 번째 테스트가 무엇인지 명시 필요 (예: "사용자가 상품 구매 후 주문번호를 받는다")

### 4. 추가 적절성 문제

#### 4.1 가격 575원의 테스트 적합성
- PayPal 최소 결제 금액 정책 확인 필요 (통화별로 최소 금액 제약 존재 가능)
- 배송비 고려 없음 (575원 상품에 배송비를 어떻게 처리?)

#### 4.2 배송 완료 후 환불의 비즈니스 로직
- "배송 완료 후에도 환불 가능" + "재고 자동 복구"는 물리적으로 모순
- 실제 제품이 고객에게 있는데 재고를 복구하는 것은 부적절
- **필요한 구분**: 
  - 배송 전 환불 = 재고 복구
  - 배송 후 환불 = 재고 복구 안 함 (반품 절차 필요)

#### 4.3 수량 제한 정책 모호함
- "한 번에 모두 구매 가능"이라고 했으나, 실제 UI에서 수량 입력 검증 로직 명세 없음
- 음수 입력, 0 입력, 재고 초과 입력 시 처리 방안 없음

---

## 종합 평가

### 정확성 요약
1. **치명적 논리 오류**: 재고 관리 시점과 결제 실패 시 처리 누락
2. **기술적 오류**: 동시성 제어 불충분, PayPal 검증 로직 부재
3. **스키마 오류**: updated_at 자동 업데이트 미지정

### 적절성 요약
1. **MVP 범위 초과**: 환불 프로세스 과도하게 복잡
2. **보안 정책 부적절**: 관리자 인증 없음
3. **명세 불완전**: 에러 케이스, API 엔드포인트 누락
4. **비즈니스 로직 모순**: 배송 완료 후 환불 시 재고 복구 문제

### 권장사항
1. **즉시 수정 필요**: 재고 관리 로직(결제 완료 시 차감으로 변경 또는 결제 포기 시 복구 로직 추가)
2. **명확화 필요**: 주문 취소 vs 환불 구분, 배송 후 환불 시 재고 처리
3. **추가 명세 필요**: API 엔드포인트, 에러 케이스, 동시성 제어 전략
4. **단순화 권장**: shipments 테이블 통합, 환불 프로세스 간소화 (MVP 목적 고려)
