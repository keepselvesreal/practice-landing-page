---
version: 2
created_date: 25-11-07 15:38
updated_date: 25-11-08
note: 주문 취소와 환불의 배송 상태 구분 명확화 (PREPARING 중복 제거)
---

## 메모

### 재고 관리
- **재고 차감 시점**: **결제 완료 시** (`PAID` 상태 전환 시)
- **재고 복구 조건**:
  - 주문 취소 (`PREPARING` 상태): 즉시 복구
  - 환불 시 (배송 상태별):
    - `SHIPPED`: 환불 승인 시 즉시 복구
    - `DELIVERED`: **물품 반송 확인 후** 복구 (`returned_at` 기록 후)
- **동시성 제어**: 트랜잭션 처리로 재고 꼬임 방지
- **재고 부족 시**: `409 Conflict` 반환, 현재 재고 수량 포함

---

### 배송비 정책 (신규)
- **기본 배송비**: 100 페소 (10000 센타보)
- **적용**: 모든 주문에 배송비 포함
- **취소/환불 시 배송비 처리**:
  - 주문 취소 (`PREPARING`): 전액 환불 (상품가 + 배송비)
  - 환불 (`SHIPPED`, `DELIVERED`): 배송비 차감 (상품가만 환불)

---

### 주문 취소
- **대상**: 결제 완료 후 (`PAID` 상태), 배송 전 (`PREPARING`)
- **처리**:
  1. 주문 상태를 `CANCELLED`로 변경
  2. 재고 자동 복구
  3. 전액 환불 (상품가 + 배송비)

---

### 환불 처리
- **환불 가능 상태**: `PAID` + 배송 상태 `SHIPPED` 또는 `DELIVERED`
  - ⚠️ `PREPARING` 상태는 **주문 취소**로 처리 (환불 불가)
- **프로세스**:
  1. 사용자가 환불 사유 입력 후 요청
  2. `refunds` 테이블에 레코드 생성 (`PENDING`)
  3. 관리자가 환불 승인
  4. PayPal API로 환불 처리 (배송비 제외)
  5. 주문 상태 `REFUNDED`, 환불 상태 `COMPLETED`
  6. 배송 상태별 재고 복구:
     - `SHIPPED`: 즉시 복구
     - `DELIVERED`: 물품 반송 확인 후 복구

---

### 배송 처리
- **shipment 생성 시점**: 결제 완료 시 자동 생성
- **상태 변경**: 관리자가 수동으로 변경 (`/admin/shipments`)

---

### 어필리에이트 커미션 정산 (신규)
- **커미션 비율**: 20% (기본값)
- **계산**: `(unit_price * quantity) * 0.20`
- **배송비 제외**: 배송비는 커미션 계산에서 제외
- **정산 조건**:
  - 배송 완료 후 N일 경과 시: `pending_commission` → 정산 가능
  - 환불 시: `pending_commission` 차감
- **추적**:
  - 주문 생성 시 `affiliate_code` 저장
  - `affiliate_stats.sale_count` 증가
  - `affiliate_stats.pending_commission` 증가

### 미반영 요구사항
- 어필리에이트 정산 N일 기준 미정의 - 추후 결정 필요
