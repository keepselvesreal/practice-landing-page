# 7장: 테스트 용이성 설계 - 추출된 정보

## 핵심 내용
- 테스트 친화적인 설계는 도메인 로직과 인프라를 분리해 복잡한 의존성을 격리한다.
- Hexagonal Architecture(Ports & Adapters)와 의존성 주입은 테스트 대역 교체와 재사용을 용이하게 한다.
- 제어 가능성(controllability)과 관찰 가능성(observability)을 확보해야 안정적인 자동화 테스트를 작성할 수 있다.
- 시간, 난수, 전역 상태 등 비결정적 요소를 추상화해 테스트에서 쉽게 치환한다.
- 테스트 곤란 패턴(긴 메서드, 숨은 의존성, 강결합 등)을 피하고, 필요 시 리팩터링으로 테스트 친화성을 높인다.

## 상세 핵심 내용

### 도메인·인프라 분리
- 데이터베이스 접근, 파일 I/O, 외부 서비스 로직을 도메인에서 분리해 DAO/Adapter에 위임.
- Hexagonal Architecture: 도메인은 포트(인터페이스)를 통해 외부 세계와 통신, 어댑터가 실제 구현 담당.
- 분리하면 도메인 테스트 시 간단한 스텁/목으로 외부 의존성을 대체할 수 있다.

### 의존성 주입과 구성
- 생성자/세터/팩토리를 활용해 의존성을 주입하고, 테스트에서 더블을 삽입할 수 있도록 한다.
- 프레임워크(Spring 등) 사용 여부와 무관하게 DI 사고방식을 갖추어야 한다.
- 객체 생성 책임을 한 곳으로 모아 테스트 설정을 단순화하고, 구성 변경이 테스트 전반에 파급되지 않도록 한다.

### 제어 가능성 확보
- 시간, 랜덤, I/O 경로 등 외부 요인을 추상화(예: `Clock`, `RandomGenerator`, 설정 인터페이스)하여 테스트에서 주입.
- 전역 싱글톤, 정적 메서드 사용을 제한하거나 래핑하여 격리성을 확보한다.
- 테스트 훅(예: 환경설정, feature flag)을 도입해 시나리오별 상태 전환을 쉽게 한다.

### 관찰 가능성 강화
- 메서드 반환값과 상태만으로 검증하기 어려울 경우 이벤트, 도메인 로그, 알림 객체 등 관찰 수단을 제공.
- 복잡한 배치나 비동기 처리는 테스트 피드백을 위해 상태 저장소/큐/샘플러 등을 노출한다.
- 테스트 전용 API를 만들기보다, 관찰 가능성을 높이는 설계 자체가 유지보수성도 향상시킴을 강조.

### 테스트 곤란 패턴과 회피 전략
- 거대한 메서드, 숨은 IO, 전역 상태, 조건부 로직 중첩은 테스트를 어렵게 만들므로 리팩터링 필요.
- 레거시 코드 개선 시 “작은 단계 리팩터링 → 테스트 추가” 사이클로 안전성을 확보한다.
- 분산된 책임을 단일 클래스로 모으거나 전략 패턴 도입 등으로 테스트 케이스 수를 줄인다.

### 테스트 자동화 고려 요소
- 테스트 데이터 조립은 빌더/DSL로 단순화; 공용 픽스처는 재사용성 vs 독립성 균형 유지.
- 빠른 테스트-느린 테스트 분리 전략, 의존성 격리로 CI 파이프라인 안정화.
- 관측/제어 지점을 문서화해 팀원이 일관된 테스트 작성 방식을 따르도록 한다.

## 상세 내용

### 설계 단계별 체크 포인트
- 아키텍처 수준: 포트·어댑터 정의, 인프라 모듈단 분리.
- 설계 수준: 클래스 책임 단일화, 협력 객체의 인터페이스 선언.
- 구현 수준: 정적 호출 제거, 가독성 높은 테스트 헬퍼, 추상화/캡슐화 유지.

### 레거시 대응
- 테스트 작성이 어려운 기존 코드에 테스트 seam 도입(메서드 추출, 래퍼 클래스)으로 진입점 마련.
- 리팩터링 전 스모크 테스트 확보 → 작은 변경 → 테스트 보강 순으로 위험 최소화.

### 문화와 프로세스
- 테스트 가능성을 코드 리뷰 항목에 포함, 설계 논의에서 테스트 전략을 함께 결정.
- QA/개발 협업으로 비즈니스 규칙에 필요한 관측 지표와 훅을 선제적으로 정의.

## 주요 화제

### 1. Hexagonal Architecture 및 포트/어댑터 패턴
- 도메인과 인프라 분리, 테스트 대역 교체 유연성.

### 2. 의존성 주입과 구성 전략
- DI 기법, 객체 생성 책임 배분, 설정 관리.

### 3. 제어·관찰 가능성 설계
- 외부 요인 추상화, 상태/이벤트 노출, 테스트 훅.

### 4. 테스트 난이도 완화 리팩터링
- 안티패턴 회피, 작은 단계 개선, 레거시 코드 전략.

## 부차 화제

### 1. 구축/운영 편의성
- 테스트 친화적 설계가 운영(모니터링, 디버깅)에도 이점 제공.

### 2. 클라우드·분산 환경 고려
- 외부 서비스/메시지 큐/DLQ 등 복잡한 인프라와 상호작용 시 테스트 전략.

### 3. 테스트 데이터 전략
- 픽스처, 빌더, 데이터베이스 시드 등 관리 기법.

### 4. 도구와 자동화
- CI 파이프라인 설계, 컨테이너/스텁 서버 활용, 계약 테스트 연계.

### 5. 팀 교육과 문서화
- 테스트 가능성 체크리스트, 설계 리뷰에 테스트 관점 통합.
