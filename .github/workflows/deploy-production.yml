name: Deploy to Production

on:
  # Staging ì›Œí¬í”Œë¡œìš° ì„±ê³µ ì‹œ ìë™ íŠ¸ë¦¬ê±°
  workflow_run:
    workflows: ["Deploy to Staging"]
    types: [completed]
    branches: [main, mvp-v2/walking-skeleton]

  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.0.0)'
        required: false
        type: string

env:
  PYTHON_VERSION: '3.11'
  STAGING_URL: 'https://kbeauty-landing-page-staging.web.app'
  PRODUCTION_URL: 'https://kbeauty-landing-page.web.app'

jobs:
  # Staging ì„±ê³µ í™•ì¸ (workflow_runìœ¼ë¡œ íŠ¸ë¦¬ê±°ëœ ê²½ìš°)
  check-staging-success:
    name: Check Staging Success
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run'
    steps:
      - name: Check if staging workflow succeeded
        if: github.event.workflow_run.conclusion != 'success'
        run: |
          echo "::error::Staging workflow did not succeed. Conclusion: ${{ github.event.workflow_run.conclusion }}"
          exit 1

      - name: Staging success confirmed
        run: |
          echo "âœ… Staging deployment and tests passed successfully!"
          echo "Staging workflow: ${{ github.event.workflow_run.html_url }}"

  # ë°°í¬ ì „ ì²´í¬
  pre-deployment-check:
    name: Pre-deployment Checks
    needs: [check-staging-success]
    if: always() && (needs.check-staging-success.result == 'success' || needs.check-staging-success.result == 'skipped')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment checklist
        run: |
          echo "## Pre-deployment Checklist" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Code reviewed and approved" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Staging tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Database migrations ready" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Environment variables configured" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ready for production deployment!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Approval required to proceed**" >> $GITHUB_STEP_SUMMARY
          echo "Go to: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY

  # ìŠ¹ì¸ ëŒ€ê¸° ì•Œë¦¼
  notify-approval-required:
    name: Notify Approval Required
    needs: [pre-deployment-check]
    runs-on: ubuntu-latest

    steps:
      - name: Create approval notification
        run: |
          echo "## ğŸš€ Production Deployment Approval Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Staging deployment and tests completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the staging deployment" >> $GITHUB_STEP_SUMMARY
          echo "2. Approve the production deployment below" >> $GITHUB_STEP_SUMMARY
          echo "3. Click 'Review deployments' and select 'Approve and deploy'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Staging URL:** ${{ env.STAGING_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "**Production URL:** ${{ env.PRODUCTION_URL }}" >> $GITHUB_STEP_SUMMARY

      # Slack/Discord ì•Œë¦¼ (ì„ íƒì‚¬í•­)
      # - name: Send Slack notification
      #   run: |
      #     curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
      #       -H 'Content-Type: application/json' \
      #       -d '{
      #         "text": "ğŸš€ Production deployment approval required!",
      #         "blocks": [
      #           {
      #             "type": "section",
      #             "text": {
      #               "type": "mrkdwn",
      #               "text": "*Staging deployment successful!*\n\nProduction deployment is ready and waiting for approval.\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Review and approve deployment>"
      #             }
      #           }
      #         ]
      #       }'

  # ìš´ì˜ ë°°í¬ (ìŠ¹ì¸ í•„ìš”)
  deploy-production:
    name: Deploy to Production
    needs: [notify-approval-required]
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ env.PRODUCTION_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: pip install uv

      # Google Cloud ì¸ì¦
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # .env.production íŒŒì¼ ìƒì„±
      - name: Create .env.production from secrets
        run: |
          cat > .env.production << EOF
          # Database (Cloud SQL Production)
          DATABASE_URL=${{ secrets.DATABASE_URL }}

          # Google Places API
          GOOGLE_PLACES_API_KEY=${{ secrets.GOOGLE_PLACES_API_KEY }}

          # PayPal Production
          PAYPAL_API_BASE=${{ secrets.PAYPAL_API_BASE }}
          PAYPAL_CLIENT_ID=${{ secrets.PAYPAL_CLIENT_ID }}
          PAYPAL_CLIENT_SECRET=${{ secrets.PAYPAL_CLIENT_SECRET }}
          PAYPAL_WEBHOOK_ID=${{ secrets.PAYPAL_WEBHOOK_ID }}

          # Gmail / SMTP
          GMAIL_ADDRESS=${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD="${{ secrets.GMAIL_APP_PASSWORD }}"
          SMTP_HOST=${{ secrets.SMTP_HOST }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}

          # Security
          ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
          ADMIN_API_KEY=${{ secrets.ADMIN_API_KEY }}

          # Production Environment
          BASE_URL=${{ env.PRODUCTION_URL }}
          EOF

      # Make ìŠ¤í¬ë¦½íŠ¸ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      # ====================
      # Backend ë°°í¬
      # ====================

      # ë°±ì—”ë“œ ë°°í¬ (Production)
      - name: Deploy backend to Cloud Run (Production)
        run: ENV_FILE=.env.production make deploy-backend

      # ====================
      # Frontend ë°°í¬
      # ====================

      # Firebase ì„œë¹„ìŠ¤ ê³„ì •ìœ¼ë¡œ ì¬ì¸ì¦
      - name: Authenticate to Google Cloud (Firebase)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      # í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ (Production)
      - name: Deploy frontend to Firebase Hosting (Production)
        run: ENV_FILE=.env.production make deploy-frontend
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        id: deploy

      - name: Create Git tag
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag -a ${{ inputs.version }} -m "Release ${{ inputs.version }}"
          git push origin ${{ inputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create deployment summary
        run: |
          echo "## ğŸš€ Production Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY

  # ìš´ì˜ í™˜ê²½ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸
  smoke-test:
    name: Production Smoke Test
    needs: deploy-production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: |
          cd backend
          uv sync

      - name: Install Playwright browsers
        run: |
          cd backend
          uv run playwright install chromium

      - name: Run smoke tests
        run: |
          cd backend
          TEST_ENV=production uv run pytest tests/e2e/test_walking_skeleton.py -v
        env:
          GOOGLE_PLACES_API_KEY: ${{ secrets.GOOGLE_PLACES_API_KEY }}
        timeout-minutes: 10

      - name: Health check
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.PRODUCTION_URL }}/api/health)
          if [ $response -eq 200 ]; then
            echo "âœ“ Health check passed"
          else
            echo "âœ— Health check failed with status $response"
            exit 1
          fi

      - name: Notify success
        if: success()
        run: |
          echo "## âœ… Production Deployment Verified" >> $GITHUB_STEP_SUMMARY
          echo "All smoke tests passed successfully!" >> $GITHUB_STEP_SUMMARY
          # Slack ì•Œë¦¼
          # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          #   -H 'Content-Type: application/json' \
          #   -d '{"text":"ğŸš€ Production deployment successful! Version: ${{ inputs.version }}"}'

      - name: Rollback on failure
        if: failure()
        run: |
          echo "::error::Smoke tests failed! Manual rollback required."
          echo "## âŒ Production Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "Smoke tests failed. Please investigate and rollback if necessary." >> $GITHUB_STEP_SUMMARY
          # ìë™ ë¡¤ë°± (ì„ íƒì‚¬í•­)
          # firebase hosting:rollback --project ${{ secrets.FIREBASE_PROJECT_ID }}
