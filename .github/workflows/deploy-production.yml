name: Deploy to Production

on:
  # Staging ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÏÑ±Í≥µ Ïãú ÏûêÎèô Ìä∏Î¶¨Í±∞
  workflow_run:
    workflows: ["Deploy to Staging"]
    types: [completed]
    branches: [main, mvp-v2/walking-skeleton]

  # ÏàòÎèô Ïã§ÌñâÎèÑ Í∞ÄÎä•
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.0.0)'
        required: false
        type: string

env:
  PYTHON_VERSION: '3.11'
  STAGING_URL: 'https://kbeauty-landing-page-staging.web.app'
  PRODUCTION_URL: 'https://kbeauty-landing-page.web.app'

jobs:
  # Staging ÏÑ±Í≥µ ÌôïÏù∏ (workflow_runÏúºÎ°ú Ìä∏Î¶¨Í±∞Îêú Í≤ΩÏö∞)
  check-staging-success:
    name: Check Staging Success
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run'
    steps:
      - name: Check if staging workflow succeeded
        if: github.event.workflow_run.conclusion != 'success'
        run: |
          echo "::error::Staging workflow did not succeed. Conclusion: ${{ github.event.workflow_run.conclusion }}"
          exit 1

      - name: Staging success confirmed
        run: |
          echo "‚úÖ Staging deployment and tests passed successfully!"
          echo "Staging workflow: ${{ github.event.workflow_run.html_url }}"

  # Î∞∞Ìè¨ Ï†Ñ Ï≤¥ÌÅ¨
  pre-deployment-check:
    name: Pre-deployment Checks
    needs: [check-staging-success]
    if: always() && (needs.check-staging-success.result == 'success' || needs.check-staging-success.result == 'skipped')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment checklist
        run: |
          echo "## Pre-deployment Checklist" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Code reviewed and approved" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Staging tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Database migrations ready" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Environment variables configured" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ready for production deployment!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ö†Ô∏è **Approval required to proceed**" >> $GITHUB_STEP_SUMMARY
          echo "Go to: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY

  # ÏäπÏù∏ ÎåÄÍ∏∞ ÏïåÎ¶º
  notify-approval-required:
    name: Notify Approval Required
    needs: [pre-deployment-check]
    runs-on: ubuntu-latest

    steps:
      - name: Create approval notification
        run: |
          echo "## üöÄ Production Deployment Approval Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Staging deployment and tests completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the staging deployment" >> $GITHUB_STEP_SUMMARY
          echo "2. Approve the production deployment below" >> $GITHUB_STEP_SUMMARY
          echo "3. Click 'Review deployments' and select 'Approve and deploy'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Staging URL:** ${{ env.STAGING_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "**Production URL:** ${{ env.PRODUCTION_URL }}" >> $GITHUB_STEP_SUMMARY

      # Slack/Discord ÏïåÎ¶º (ÏÑ†ÌÉùÏÇ¨Ìï≠)
      # - name: Send Slack notification
      #   run: |
      #     curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
      #       -H 'Content-Type: application/json' \
      #       -d '{
      #         "text": "üöÄ Production deployment approval required!",
      #         "blocks": [
      #           {
      #             "type": "section",
      #             "text": {
      #               "type": "mrkdwn",
      #               "text": "*Staging deployment successful!*\n\nProduction deployment is ready and waiting for approval.\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Review and approve deployment>"
      #             }
      #           }
      #         ]
      #       }'

  # Ïö¥ÏòÅ Î∞∞Ìè¨ (ÏäπÏù∏ ÌïÑÏöî)
  deploy-production:
    name: Deploy to Production
    needs: [notify-approval-required]
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ env.PRODUCTION_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: pip install uv

      # Google Cloud Ïù∏Ï¶ù
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Make Ïä§ÌÅ¨Î¶ΩÌä∏Ïóê Ïã§Ìñâ Í∂åÌïú Î∂ÄÏó¨
      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      # .env.production ÌååÏùº ÏÉùÏÑ±
      - name: Create .env.production from secrets
        run: |
          cat > .env.production << EOF
          # Database (Cloud SQL Production)
          DATABASE_URL=${{ secrets.DATABASE_URL }}

          # Google Places API
          GOOGLE_PLACES_API_KEY=${{ secrets.GOOGLE_PLACES_API_KEY }}

          # PayPal Production
          PAYPAL_API_BASE=${{ secrets.PAYPAL_API_BASE }}
          PAYPAL_CLIENT_ID=${{ secrets.PAYPAL_CLIENT_ID }}
          PAYPAL_CLIENT_SECRET=${{ secrets.PAYPAL_CLIENT_SECRET }}
          PAYPAL_WEBHOOK_ID=${{ secrets.PAYPAL_WEBHOOK_ID }}

          # Gmail / SMTP
          GMAIL_ADDRESS=${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD="${{ secrets.GMAIL_APP_PASSWORD }}"

          # Security
          ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
          ADMIN_API_KEY=${{ secrets.ADMIN_API_KEY }}

          # Production Environment
          BASE_URL=${{ env.PRODUCTION_URL }}
          EOF

      # ====================
      # Backend Î∞∞Ìè¨
      # ====================

      # Î∞±ÏóîÎìú Î∞∞Ìè¨ (Production)
      - name: Deploy backend to Cloud Run (Production)
        run: make deploy-production-backend

      # ====================
      # Frontend Î∞∞Ìè¨
      # ====================

      # Firebase ÏÑúÎπÑÏä§ Í≥ÑÏ†ïÏúºÎ°ú Ïû¨Ïù∏Ï¶ù
      - name: Authenticate to Google Cloud (Firebase)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      # ÌîÑÎ°†Ìä∏ÏóîÎìú Î∞∞Ìè¨ (Production)
      - name: Deploy frontend to Firebase Hosting (Production)
        run: make deploy-production-frontend
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        id: deploy

      - name: Create deployment summary
        run: |
          echo "## üöÄ Production Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
