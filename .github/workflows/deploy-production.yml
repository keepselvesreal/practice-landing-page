name: Deploy to Production

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë§Œ í—ˆìš©
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.0.0)'
        required: true
        type: string

env:
  PYTHON_VERSION: '3.11'
  PRODUCTION_URL: 'https://kbeauty-landing-page.web.app'

jobs:
  # ë°°í¬ ì „ ì²´í¬
  pre-deployment-check:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify staging tests passed
        run: |
          echo "Checking if staging tests passed..."
          # ì‹¤ì œë¡œëŠ” ì´ì „ ì›Œí¬í”Œë¡œìš° ì„±ê³µ ì—¬ë¶€ë¥¼ í™•ì¸
          # gh run list --workflow=deploy-staging.yml --limit 1 --json conclusion
          echo "âœ“ Staging tests verified"

      - name: Create deployment checklist
        run: |
          echo "## Pre-deployment Checklist" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Code reviewed and approved" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Staging tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Database migrations ready" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Environment variables configured" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY

  # ìš´ì˜ ë°°í¬ (ìŠ¹ì¸ í•„ìš”)
  deploy-production:
    name: Deploy to Production
    needs: pre-deployment-check
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ env.PRODUCTION_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # ====================
      # Backend ë°°í¬
      # ====================

      # ì˜µì…˜ 1: Google Cloud Run
      # - name: Authenticate to Google Cloud
      #   uses: google-github-actions/auth@v2
      #   with:
      #     credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}
      #
      # - name: Deploy backend to Cloud Run (Production)
      #   run: |
      #     gcloud run deploy kbeauty-backend-prod \
      #       --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/kbeauty-backend:${{ inputs.version }} \
      #       --platform managed \
      #       --region asia-northeast3 \
      #       --allow-unauthenticated \
      #       --min-instances 1 \
      #       --max-instances 10

      # ì˜µì…˜ 2: Database Migration (ìš´ì˜ DB)
      # - name: Run database migrations
      #   run: |
      #     # ìš´ì˜ DBì— ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
      #     DATABASE_URL=${{ secrets.DATABASE_URL_PROD }} \
      #       cd backend && uv run alembic upgrade head

      # ====================
      # Frontend ë°°í¬
      # ====================

      - name: Deploy frontend to Firebase Hosting (Production)
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_PROD }}
          channelId: live
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}
        id: deploy

      - name: Create Git tag
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag -a ${{ inputs.version }} -m "Release ${{ inputs.version }}"
          git push origin ${{ inputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create deployment summary
        run: |
          echo "## ğŸš€ Production Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY

  # ìš´ì˜ í™˜ê²½ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸
  smoke-test:
    name: Production Smoke Test
    needs: deploy-production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: |
          cd backend
          uv sync

      - name: Install Playwright browsers
        run: |
          cd backend
          uv run playwright install chromium

      - name: Run smoke tests
        run: |
          cd backend
          TEST_ENV=production uv run pytest tests/e2e/test_walking_skeleton.py -v
        env:
          GOOGLE_PLACES_API_KEY: ${{ secrets.GOOGLE_PLACES_API_KEY }}
        timeout-minutes: 10

      - name: Health check
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.PRODUCTION_URL }}/api/health)
          if [ $response -eq 200 ]; then
            echo "âœ“ Health check passed"
          else
            echo "âœ— Health check failed with status $response"
            exit 1
          fi

      - name: Notify success
        if: success()
        run: |
          echo "## âœ… Production Deployment Verified" >> $GITHUB_STEP_SUMMARY
          echo "All smoke tests passed successfully!" >> $GITHUB_STEP_SUMMARY
          # Slack ì•Œë¦¼
          # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          #   -H 'Content-Type: application/json' \
          #   -d '{"text":"ğŸš€ Production deployment successful! Version: ${{ inputs.version }}"}'

      - name: Rollback on failure
        if: failure()
        run: |
          echo "::error::Smoke tests failed! Manual rollback required."
          echo "## âŒ Production Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "Smoke tests failed. Please investigate and rollback if necessary." >> $GITHUB_STEP_SUMMARY
          # ìë™ ë¡¤ë°± (ì„ íƒì‚¬í•­)
          # firebase hosting:rollback --project ${{ secrets.FIREBASE_PROJECT_ID }}
