name: Deploy to Staging

on:
  push:
    branches: [main, mvp-v2/walking-skeleton]
  workflow_dispatch:  # 수동 실행 가능

env:
  PYTHON_VERSION: '3.11'

jobs:
  deploy-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://kbeauty-landing-page-staging.web.app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: pip install uv

      # ====================
      # Backend 빌드 (Docker 이미지)
      # ====================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Google Cloud Run 배포
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Build and deploy backend with Cloud Build
        run: |
          gcloud builds submit backend/ \
            --config=backend/cloudbuild.yaml \
            --substitutions="_DATABASE_URL=${{ secrets.DATABASE_URL }},_GMAIL_ADDRESS=${{ secrets.GMAIL_ADDRESS }},_GMAIL_APP_PASSWORD=${{ secrets.GMAIL_APP_PASSWORD }},_SMTP_HOST=${{ secrets.SMTP_HOST }},_SMTP_PORT=${{ secrets.SMTP_PORT }},_GOOGLE_PLACES_API_KEY=${{ secrets.GOOGLE_PLACES_API_KEY }},_PAYPAL_CLIENT_ID=${{ secrets.PAYPAL_CLIENT_ID }},_PAYPAL_CLIENT_SECRET=${{ secrets.PAYPAL_CLIENT_SECRET }},_PAYPAL_API_BASE=${{ secrets.PAYPAL_API_BASE }}"

      # 옵션 2: AWS ECS/Fargate 배포 (예시)
      # - name: Configure AWS credentials
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     aws-region: ap-northeast-2

      # 옵션 3: Heroku 배포 (예시)
      # - name: Deploy backend to Heroku
      #   uses: akhileshns/heroku-deploy@v3.13.15
      #   with:
      #     heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
      #     heroku_app_name: kbeauty-backend-staging
      #     heroku_email: ${{ secrets.HEROKU_EMAIL }}
      #     appdir: backend

      # ====================
      # Frontend 배포 (정적 파일)
      # ====================

      # Firebase Hosting 배포 (멀티 사이트)
      - name: Deploy frontend to Firebase Hosting (Staging)
        run: |
          echo "$FIREBASE_SERVICE_ACCOUNT" > $HOME/gcp-key.json
          export GOOGLE_APPLICATION_CREDENTIALS="$HOME/gcp-key.json"
          npm install -g firebase-tools
          firebase deploy --only hosting:staging --project ${{ secrets.FIREBASE_PROJECT_ID }}
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      # 또는 다른 정적 호스팅 서비스
      # - name: Deploy to Netlify
      #   uses: nwtgck/actions-netlify@v3.0
      #   with:
      #     publish-dir: './frontend'
      #     production-deploy: false
      #     alias: staging
      #   env:
      #     NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      #     NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Output deployment URL
        run: |
          echo "Staging URL: https://kbeauty-landing-page-staging.web.app"

  test-staging:
    name: Test Staging Environment
    needs: deploy-staging
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: |
          cd backend
          uv sync

      - name: Install Playwright browsers
        run: |
          cd backend
          uv run playwright install chromium

      - name: Run E2E tests against staging
        run: |
          cd backend
          TEST_ENV=production uv run pytest tests/e2e/ -v --tb=short
        env:
          # Staging 환경 URL (production TEST_ENV 사용, URL만 staging)
          BASE_URL: https://kbeauty-landing-page-staging.web.app

      - name: Create test report
        if: always()
        run: |
          echo "## Staging Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: Staging" >> $GITHUB_STEP_SUMMARY
          echo "- URL: https://kbeauty-landing-page-staging.web.app" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Staging deployment tests failed"
          # Slack/Discord 알림 추가 가능
          # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          #   -H 'Content-Type: application/json' \
          #   -d '{"text":"Staging deployment failed!"}'
