# 나

# ai

## 작업 계획 조정

### Outside-In TDD와 CI/CD 미설정

**문제점**:
- 1-a 단계 완료까지 로컬 환경에서만 테스트 진행
- CI/CD 파이프라인 미구축
- 환경 차이로 인한 문제 조기 발견 불가

**Outside-In TDD 원칙**:
- "항상 빌드 가능한 상태 유지"
- "작은 단위로 자주 통합"

**현재 상황**:
```
로컬에서만 테스트 → 커밋 → 푸시 (CI 없음)
```

**제대로 된 흐름**:
```
로컬에서 테스트 → 커밋 → 푸시 → CI에서 자동 테스트 → GREEN 확인
```

**결정**:
- 1-c 단계 시작 전 GitHub Actions로 최소 CI 설정
- Integration/Unit 테스트 자동 실행
- E2E는 제외 (Playwright 설정 복잡도)

---

### 재고 차감 시점 불일치 발견

**현재 구현** (`backend/api/orders.py:92`):
```python
# PayPal Order 생성 성공 후
product.stock -= order_data.quantity
```
→ 주문 생성 시점에 즉시 차감

**계획서** (`docs/05-business-logic.md`):
- 재고 차감 시점: **결제 완료 시** (`PAID` 상태 전환 시)

**문제**:
- 현재: PayPal로 리다이렉트만 됨 (결제 미완료)
- 사용자가 PayPal에서 취소 → 재고 영구 차감
- 결제 완료/실패를 알 방법 없음 (Webhook 없음)

**해결 계획**:
- 1-c 단계에서 PayPal Webhook 구현
- 재고 차감을 Webhook 수신 시점으로 이동
  - `PAYMENT.CAPTURE.COMPLETED` → 재고 차감
  - `PAYMENT.CAPTURE.DENIED` → 재고 복원 (차감 안 했으니 불필요)

**Technical Debt**:
- 현재 구현은 임시방편 (MVP 검증용)
- 1-c 단계에서 리팩터링 필수

---

### 수정된 진행 순서

**당초 계획서 순서** (`docs/11-methodology.md`):
```
1. 1-b단계: 주문 조회 API (Mock 데이터)
2. 1-a단계: 주문 생성 + PayPal 결제 + 재고 차감 ✅
3. 2단계: 배송 추적 시스템
4. 3단계: 환불 시스템
5. 추가 기능: 어필리에이트, 이메일
```

**조정된 순서**:
```
✅ 1-a: 주문 생성 + PayPal 결제 + 재고 차감 (완료)
✅ 1-b: 주문 조회 API (이미 구현됨)

🔄 1-c: PayPal Webhook 기반 결제 완료 플로우 ⭐
  - Webhook 엔드포인트
  - 재고 차감 리팩터링 (주문 생성 → 결제 완료)
  - 주문 확인 이메일 발송
  - 결제 실패 시 재고 복원

📦 2단계: 배송 추적 시스템
  - shipments 관리
  - 배송 완료 이메일

🖥️ 3단계: 주문 조회 페이지 (UI)
  - 배송 정보 포함한 주문 조회

🔙 4단계: 취소/환불
  - 4-a: 주문 취소
  - 4-b: 환불 시스템

🤝 5단계: 어필리에이트
```

**조정 이유**:
1. **Webhook 우선**: 재고/이메일의 올바른 처리를 위한 기반
2. **주문 조회 API 선행**: 이미 구현되어 있음 (Mock 데이터)
3. **주문 조회 페이지 후순위**: 배송 정보 없이는 의미 없음
4. **이메일 분산**:
   - 주문 확인 (1-c)
   - 배송 완료 (2단계)

---

## 주문 취소와 환불 구분 명확화

### 문제 발견

**계획서 원본** (`docs/05-business-logic.md` v1):
- 재고 복구 조건:
  - 주문 취소: 즉시 복구
  - 환불 시 (`PREPARING`, `SHIPPED`): 즉시 복구
  - 환불 시 (`DELIVERED`): 반송 후 복구

**문제점**:
- `PREPARING` 상태가 주문 취소와 환불에 중복 출현
- 사용자 입장: "배송 전인데 취소해야 하나? 환불 요청해야 하나?"
- 로직 복잡도 증가: 동일 상태에서 두 가지 플로우

---

### 수정된 정책

**명확한 구분**:

| 구분 | 배송 상태 | 승인 | 환불액 | 재고 |
|------|----------|------|--------|------|
| **주문 취소** | `PREPARING` | 자동 | 전액 (상품가 + 배송비) | 즉시 복구 |
| **환불** | `SHIPPED`, `DELIVERED` | 관리자 | 상품가만 (배송비 제외) | 조건부 |

**로직**:
```python
if shipment_status == "PREPARING":
    # 취소만 가능
    cancel_order() -> 전액 환불, 즉시 재고 복구

elif shipment_status in ["SHIPPED", "DELIVERED"]:
    # 환불만 가능
    request_refund() -> 관리자 승인 후 환불 (배송비 제외)
```

**사용자 경험 개선**:
- 배송 전: "취소" 버튼만 표시 (명확)
- 배송 후: "환불 요청" 버튼만 표시 (명확)
- 중복 방지 → 혼란 제거

---

### 프로젝트 문서 수정

**파일**: `docs/05-business-logic.md`
- `version: 1` → `version: 2`
- `updated_date: 25-11-08`

**변경 내역**:

#### 1. 재고 관리
```diff
- 재고 복구 조건:
-   - 환불 시 (배송 상태별):
-     - `PREPARING`, `SHIPPED`: 환불 승인 시 즉시 복구
-     - `DELIVERED`: 물품 반송 확인 후 복구

+ 재고 복구 조건:
+   - 주문 취소 (`PREPARING` 상태): 즉시 복구
+   - 환불 시 (배송 상태별):
+     - `SHIPPED`: 환불 승인 시 즉시 복구
+     - `DELIVERED`: 물품 반송 확인 후 복구
```

#### 2. 배송비 정책
```diff
- 환불 시 배송비 처리:
-   - `PREPARING`: 전액 환불 (상품가 + 배송비)

+ 취소/환불 시 배송비 처리:
+   - 주문 취소 (`PREPARING`): 전액 환불 (상품가 + 배송비)
+   - 환불 (`SHIPPED`, `DELIVERED`): 배송비 차감 (상품가만 환불)
```

#### 3. 환불 처리
```diff
- 환불 가능 상태: `PAID` (모든 배송 상태에서 가능)

+ 환불 가능 상태: `PAID` + 배송 상태 `SHIPPED` 또는 `DELIVERED`
+   - ⚠️ `PREPARING` 상태는 **주문 취소**로 처리 (환불 불가)
```

**커밋**: 문서 수정 후 별도 커밋 예정

