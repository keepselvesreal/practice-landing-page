# 나
- **1-a단계**: 주문 생성 + PayPal 결제 + 재고 차감 
    - 정상적?이라면 아마 재고 차감 구현되고 나서야 전체 acceptance test, 즉 e2e 테스트 통과하게 구성됐어야 할 거 같은데, 여기서는 재고 차감 진행 전, 즉 paypal 결제 때부터 이미 e2e 통과했음. 
    - e2e, 즉 acceptance test를 어떻게 설정하냐 차이일 거 같긴 한데. 기본적으로는 저 세 개가 하나로 묶인 상태이니 재고 차감까지 구현되고 나서야 이번 story의 acceptance test, 즉 e2e 통과되는 게 맞는 거 같음 
- 기존에는 test_customer_can_create_order_and_pay_with_paypal만 e2e 테스트만 있어서 재고 차감 구현 여부를 확인할 수 있는, 달리 말하면 재고 차감 기능 구현 여부를 테스트하여 이 기능이 구현되지 않았을 때는 red가 발생하는 테스트가 부재한 상황이었는데, 재고 차감이 정상 동작해야 오류가 발생하고, 이 오류 정상 발생 여부로 재고 차감 기능 구현 여부 판단하는 test_customer_cannot_order_more_than_available_stock 테스트 추가함

# ai

## 작업 내용

### 재고 차감 기능 구현
1. **Product 모델 생성** (`backend/models/product.py`)
   - `stock` 필드 추가 (재고 수량 관리)
   - 가격, 이름 등 상품 기본 정보 포함

2. **Mock 상품 데이터 생성** (`backend/api/orders.py:16-24`)
   ```python
   MOCK_PRODUCTS = {
       1: Product(
           id=1,
           name="조선미녀 맑은쌀 선크림 50ml",
           price=57500,
           stock=10,  # 초기 재고 10개
       )
   }
   ```

3. **재고 확인 및 차감 로직** (`backend/api/orders.py:72-77, 91-92`)
   ```python
   # 재고 확인
   if product.stock < order_data.quantity:
       raise HTTPException(status_code=409, ...)

   # PayPal Order 생성 성공 후
   product.stock -= order_data.quantity
   ```

4. **E2E 테스트 추가** (`tests/e2e/test_order_creation_flow.py:86-113`)
   - `test_customer_cannot_order_more_than_available_stock`
   - 재고(10개) 초과 주문(15개) → 에러 메시지 검증

### RED-GREEN 사이클 수행
1. **RED**: 재고 로직 주석 처리 → E2E 테스트 실패
   - 15개 주문해도 PayPal로 리다이렉트
   - 에러 메시지 표시 안 됨

2. **GREEN**: 재고 로직 활성화 → E2E 테스트 통과
   - 409 Conflict 반환
   - 프론트엔드 에러 메시지 표시

### 검증
- Integration 테스트 (4개): PASSED
  - `test_create_order_with_insufficient_stock_returns_409` 활성화
- E2E 테스트 (3개): PASSED
  - PayPal 결제 플로우
  - 재고 부족 검증
  - UI 렌더링 확인

---

## 예외 요소

### 1. Acceptance Test 범위 설정 오류
**문제**:
- PayPal 결제 구현 시점에 이미 E2E 테스트 통과
- 재고 차감 기능 없이도 Acceptance Test가 GREEN
- 1-a 단계 스토리 ("주문 생성 + PayPal 결제 + 재고 차감") 중 일부만 검증

**원인**:
- 기존 E2E 테스트 (`test_customer_can_create_order_and_pay_with_paypal`)가 PayPal 리다이렉트만 확인
- 재고 차감은 전혀 검증하지 않음
- Outside-In TDD 원칙 위반: Acceptance Test가 전체 스토리를 검증해야 함

**해결**:
- 새로운 E2E 테스트 추가: `test_customer_cannot_order_more_than_available_stock`
- 재고 초과 주문 시나리오로 재고 확인 로직 검증
- 이후 재고 로직 임시 제거 → RED 확인 → 복원 → GREEN

### 2. E2E 테스트 구현 시 UI 제약
**문제**:
- 프론트엔드 `<select id="quantity">`의 option이 1-10까지만 존재
- 재고 초과(15개) 주문을 테스트하려면 JavaScript로 직접 값 설정 필요

**시도한 방법들**:
```python
# 시도 1: 직접 value 설정 (실패 - 422 에러)
page.evaluate("document.querySelector('#quantity').value = '15'")

# 시도 2: option 동적 추가 후 선택 (성공)
page.evaluate("""
    const selectEl = document.querySelector('#quantity');
    const option = document.createElement('option');
    option.value = '15';
    option.text = '15';
    selectEl.add(option);
    selectEl.value = '15';
    selectEl.dispatchEvent(new Event('change'));  # 총액 계산 트리거
""")
```

**원인**:
- 단순히 value만 설정하면 FastAPI Pydantic 검증에서 문자열로 인식
- `dispatchEvent(new Event('change'))`로 이벤트 트리거해야 프론트엔드 로직 정상 동작

---

## 이해 요소

### Outside-In TDD의 Acceptance Test 역할

**핵심**: Acceptance Test는 사용자 스토리 **전체**를 검증해야 한다.

**스토리**: "주문 생성 + PayPal 결제 + 재고 차감"
- A: 주문 생성
- B: PayPal 결제
- C: 재고 차감

**올바른 RED-GREEN 사이클**:
```
1. E2E 작성 (A+B+C 모두 검증) → RED
2. A 구현 → 여전히 RED
3. B 구현 → 여전히 RED
4. C 구현 → GREEN ✅
```

**잘못된 사이클 (이번에 발생한 문제)**:
```
1. E2E 작성 (A+B만 검증)
2. A+B 구현 → GREEN ❌ (너무 일찍 통과)
3. C 구현 → 여전히 GREEN (E2E가 검증 안 함)
```

**교훈**:
- Acceptance Test는 스토리의 모든 요소를 검증해야 함
- 일부만 검증하면 기능 누락 가능성 높음
- 테스트가 GREEN이어도 실제로는 불완전할 수 있음

### 재고 차감 플로우와 시점

**실행 순서**:
```
주문 요청
  → 상품 조회 (orders.py:65)
  → 재고 확인 (orders.py:73)
  → PayPal Order 생성 (orders.py:83)
  → 재고 차감 (orders.py:92)
  → 응답 반환
```

**재고 차감 시점의 의미**:
- PayPal Order 생성 **성공 후** 차감
- PayPal API 실패 시 재고 차감 안 됨
- 하지만 결제는 아직 완료 안 된 상태 (approval 대기)

---

## 판단 요소

### 재고 차감 시점 선택

**상황**: 언제 재고를 차감할 것인가?

**선택지 1**: 주문 생성 시 즉시 차감 (채택)
- ✅ 간단한 구현 (Webhook 불필요)
- ✅ 재고 선점 (동시 주문 시 재고 보호)
- ⚠️ 결제 실패 시 재고 복원 로직 필요 (v2에서 개선)

**선택지 2**: PayPal 결제 완료 후 차감
- ❌ Webhook 구현 필요 (복잡도 증가)
- ❌ 결제 완료 시점까지 재고 미확보 (동시 주문 문제)
- ✅ 실제 결제된 주문만 재고 차감 (정확성)

**현재 상황에서 최선인 이유**:
- 1-a 단계 목표: 빠른 동작 검증
- Webhook은 2단계 이후로 연기
- 재고 선점으로 동시성 문제 일부 완화

### E2E에서 재고 검증 방법

**상황**: UI에 재고 표시 없음, 어떻게 재고 차감을 E2E에서 검증할까?

**선택지 1**: UI에 재고 표시 추가 → 주문 후 감소 확인
- ❌ UI 수정 필요 (1-a 단계 범위 초과)
- ❌ 테스트 복잡도 증가 (재고 숫자 파싱 필요)

**선택지 2**: 재고 초과 주문 → 에러 메시지 확인 (채택)
- ✅ 사용자 관점에서 검증 가능
- ✅ UI 수정 불필요
- ✅ 에러 처리 플로우도 함께 검증

**선택지 3**: 연속 주문으로 재고 소진 확인
- ❌ 테스트 복잡도 매우 높음
- ❌ 재고 상태 초기화 로직 필요
- ❌ PayPal API 호출 여러 번 (느림)

---

## 개선 요소

### 함수/클래스 차원
**현재 한계**: Mock 딕셔너리 직접 수정으로 인한 동시성 문제
- 두 요청이 동시에 `product.stock -= order_data.quantity` 실행 시 race condition
- 테스트 간 재고 상태 공유 (테스트 독립성 위반 가능성)

**개선 방향**: 재고 관리 서비스 분리
```python
class StockService:
    def __init__(self):
        self._lock = Lock()

    def reserve_stock(self, product_id: int, quantity: int) -> bool:
        with self._lock:
            if product.stock < quantity:
                return False
            product.stock -= quantity
            return True
```

**이점**:
- 동시성 제어 명시적
- 테스트에서 Mock 주입 가능
- 재고 관련 로직 중앙화

### 아키텍처 차원
**현재 한계**: 결제 실패 시 재고 복원 로직 없음
- 주문 생성 → 재고 차감 → PayPal 승인 대기
- 사용자가 PayPal에서 취소 → 재고 영구 차감

**개선 방향**: Saga 패턴 또는 보상 트랜잭션
```python
# Webhook으로 PayPal 결제 완료/실패 수신
@router.post("/webhooks/paypal")
async def paypal_webhook(event: PayPalEvent):
    if event.type == "PAYMENT.CAPTURE.DENIED":
        # 재고 복원
        product.stock += order.quantity
```

또는

```python
# 재고 예약 개념 도입
- 주문 생성 시: reserved_stock += quantity
- 결제 완료 시: reserved_stock -= quantity, stock -= quantity
- 결제 실패/만료 시: reserved_stock -= quantity
```

**이점**:
- 결제 실패 시 재고 자동 복원
- 재고 정확성 보장
- 사용자 경험 개선 (취소 후 재주문 가능)